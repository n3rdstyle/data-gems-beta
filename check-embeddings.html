<!DOCTYPE html>
<html>
<head>
  <title>Check Data Gems Embeddings & HNSW</title>
  <style>
    body {
      font-family: 'SF Mono', Monaco, monospace;
      max-width: 900px;
      margin: 50px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    .card {
      background: #2a2a2a;
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
      border: 1px solid #3a3a3a;
    }
    h1 {
      margin-top: 0;
      color: #4a9eff;
    }
    h2 {
      color: #6ab7ff;
      font-size: 18px;
      margin-top: 0;
    }
    .stat {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #3a3a3a;
    }
    .stat:last-child {
      border-bottom: none;
    }
    .label {
      color: #888;
    }
    .value {
      color: #4a9eff;
      font-weight: bold;
    }
    .success {
      color: #4caf50;
    }
    .warning {
      color: #ff9800;
    }
    .error {
      color: #f44336;
    }
    button {
      background: #4a9eff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-family: inherit;
      margin-right: 10px;
      margin-top: 10px;
    }
    button:hover {
      background: #3a8eef;
    }
    pre {
      background: #1a1a1a;
      padding: 12px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      border: 1px solid #3a3a3a;
    }
    .gem-sample {
      background: #1a1a1a;
      padding: 12px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #3a3a3a;
    }
    .vector-preview {
      color: #888;
      font-size: 11px;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîç Embeddings & HNSW Status</h1>
    <button onclick="checkStatus()">üîÑ Check Status</button>
    <button onclick="checkSampleGem()">üìä Show Sample Gem</button>
    <button onclick="testSearch()">üîé Test Vector Search</button>
  </div>

  <div class="card" id="statsCard" style="display: none;">
    <h2>Database Statistics</h2>
    <div id="stats"></div>
  </div>

  <div class="card" id="hnswCard" style="display: none;">
    <h2>HNSW Index Status</h2>
    <div id="hnswStats"></div>
  </div>

  <div class="card" id="sampleCard" style="display: none;">
    <h2>Sample Gem</h2>
    <div id="sampleGem"></div>
  </div>

  <div class="card" id="searchCard" style="display: none;">
    <h2>Vector Search Test</h2>
    <div id="searchResults"></div>
  </div>

  <script type="module">
    import { getContextEngine } from './engine/context-engine.js';
    import { getVectorStore } from './engine/vector-store.js';

    let engine = null;

    window.checkStatus = async function() {
      try {
        console.log('Initializing Context Engine...');
        engine = await getContextEngine();

        // Get database stats
        const stats = await engine.getStats();
        console.log('Stats:', stats);

        // Display database stats
        const statsCard = document.getElementById('statsCard');
        const statsDiv = document.getElementById('stats');
        statsCard.style.display = 'block';

        statsDiv.innerHTML = `
          <div class="stat">
            <span class="label">Total Gems:</span>
            <span class="value">${stats.database.totalGems || 0}</span>
          </div>
          <div class="stat">
            <span class="label">Primary Gems:</span>
            <span class="value">${stats.database.primaryGems || 0}</span>
          </div>
          <div class="stat">
            <span class="label">Child Gems:</span>
            <span class="value">${stats.database.childGems || 0}</span>
          </div>
          <div class="stat">
            <span class="label">BM25 Index:</span>
            <span class="value ${stats.bm25.isReady ? 'success' : 'error'}">
              ${stats.bm25.isReady ? '‚úì Ready' : '‚úó Not Ready'}
            </span>
          </div>
          <div class="stat">
            <span class="label">BM25 Indexed Gems:</span>
            <span class="value">${stats.bm25.indexedGems || 0}</span>
          </div>
          <div class="stat">
            <span class="label">Embedder:</span>
            <span class="value ${stats.enrichment.embedder ? 'success' : 'warning'}">
              ${stats.enrichment.embedder || 'Not loaded'}
            </span>
          </div>
          <div class="stat">
            <span class="label">Embedding Dimension:</span>
            <span class="value">${stats.enrichment.embeddingDim || 'N/A'}</span>
          </div>
        `;

        // Check HNSW index
        const vectorStore = await getVectorStore();
        const hnswStats = vectorStore.getIndexStats();
        console.log('HNSW Stats:', hnswStats);

        const hnswCard = document.getElementById('hnswCard');
        const hnswDiv = document.getElementById('hnswStats');
        hnswCard.style.display = 'block';

        if (hnswStats.ready) {
          hnswDiv.innerHTML = `
            <div class="stat">
              <span class="label">Status:</span>
              <span class="value success">‚úì Ready & Loaded</span>
            </div>
            <div class="stat">
              <span class="label">Indexed Vectors:</span>
              <span class="value">${hnswStats.size || 0}</span>
            </div>
            <div class="stat">
              <span class="label">Vector Dimension:</span>
              <span class="value">${hnswStats.dimension || 'N/A'}</span>
            </div>
            <div class="stat">
              <span class="label">M (connections):</span>
              <span class="value">${hnswStats.M || 'N/A'}</span>
            </div>
            <div class="stat">
              <span class="label">Entry Point:</span>
              <span class="value">${hnswStats.entryPoint || 'N/A'}</span>
            </div>
            <div class="stat">
              <span class="label">Entry Point Layer:</span>
              <span class="value">${hnswStats.entryPointLayer || 'N/A'}</span>
            </div>
            <div class="stat">
              <span class="label">Layer Distribution:</span>
              <span class="value" style="font-size: 11px;">${JSON.stringify(hnswStats.layerDistribution || {})}</span>
            </div>
          `;

          // Check localStorage
          const hnswIndexData = localStorage.getItem('hnsw_index');
          if (hnswIndexData) {
            const sizeKB = Math.round(hnswIndexData.length / 1024);
            hnswDiv.innerHTML += `
              <div class="stat">
                <span class="label">Persisted to localStorage:</span>
                <span class="value success">‚úì Yes (${sizeKB} KB)</span>
              </div>
            `;
          }
        } else {
          hnswDiv.innerHTML = `
            <div class="stat">
              <span class="label">Status:</span>
              <span class="value error">‚úó Not Ready</span>
            </div>
            <p style="color: #ff9800; margin-top: 12px;">
              HNSW index is not ready. This means no vectors were found in the database.
            </p>
          `;
        }

      } catch (error) {
        console.error('Error checking status:', error);
        alert('Error: ' + error.message);
      }
    };

    window.checkSampleGem = async function() {
      try {
        if (!engine) {
          engine = await getContextEngine();
        }

        // Get all primary gems
        const gems = await engine.getAllGems({ isPrimary: true });

        if (gems.length === 0) {
          alert('No gems found in database');
          return;
        }

        // Pick a random gem
        const randomGem = gems[Math.floor(Math.random() * gems.length)];
        console.log('Sample gem:', randomGem);

        const sampleCard = document.getElementById('sampleCard');
        const sampleDiv = document.getElementById('sampleGem');
        sampleCard.style.display = 'block';

        const hasVector = randomGem.vector && Array.isArray(randomGem.vector);
        const vectorDim = hasVector ? randomGem.vector.length : 0;
        const vectorPreview = hasVector
          ? `[${randomGem.vector.slice(0, 5).map(v => v.toFixed(3)).join(', ')}...]`
          : 'No vector';

        sampleDiv.innerHTML = `
          <div class="gem-sample">
            <strong>ID:</strong> ${randomGem.id}<br>
            <strong>Value:</strong> ${randomGem.value}<br>
            <strong>Semantic Type:</strong> ${randomGem.semanticType || 'N/A'}<br>
            <strong>Topic:</strong> ${randomGem.topic || 'N/A'}<br>
            <strong>Vector:</strong> <span class="${hasVector ? 'success' : 'error'}">
              ${hasVector ? `‚úì ${vectorDim}-dimensional` : '‚úó Missing'}
            </span>
            <div class="vector-preview">${vectorPreview}</div>
            ${randomGem.keywords ? `<strong>Keywords:</strong> ${randomGem.keywords.slice(0, 10).join(', ')}` : ''}
          </div>
          <button onclick="checkSampleGem()">üé≤ Show Another Random Gem</button>
        `;

      } catch (error) {
        console.error('Error checking sample gem:', error);
        alert('Error: ' + error.message);
      }
    };

    window.testSearch = async function() {
      try {
        if (!engine) {
          engine = await getContextEngine();
        }

        const query = prompt('Enter search query:', 'test query');
        if (!query) return;

        console.log('Searching for:', query);
        const startTime = performance.now();
        const results = await engine.search({
          query,
          limit: 5
        });
        const elapsed = performance.now() - startTime;

        console.log('Search results:', results);

        const searchCard = document.getElementById('searchCard');
        const searchDiv = document.getElementById('searchResults');
        searchCard.style.display = 'block';

        searchDiv.innerHTML = `
          <div class="stat">
            <span class="label">Query:</span>
            <span class="value">"${query}"</span>
          </div>
          <div class="stat">
            <span class="label">Search Time:</span>
            <span class="value success">${elapsed.toFixed(2)}ms</span>
          </div>
          <div class="stat">
            <span class="label">Results:</span>
            <span class="value">${results.length}</span>
          </div>
          <h3 style="margin-top: 20px; color: #6ab7ff;">Top Results:</h3>
          ${results.map((r, i) => `
            <div class="gem-sample">
              <strong>#${i + 1}</strong> (score: ${r.score ? r.score.toFixed(3) : 'N/A'})<br>
              ${r.value.substring(0, 100)}${r.value.length > 100 ? '...' : ''}
            </div>
          `).join('')}
        `;

      } catch (error) {
        console.error('Error testing search:', error);
        alert('Error: ' + error.message);
      }
    };

    // Auto-check on load
    console.log('Auto-checking status...');
    setTimeout(() => checkStatus(), 500);
  </script>
</body>
</html>
